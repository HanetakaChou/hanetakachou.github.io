# Diffusion Profile

## DOM (Discrete Ordinates Method)  

## Diffusion Profile  

By "Further Reading" of "15 Light Transport II: Volume Rendering" of [PBR Book V3](https://www.pbr-book.org/3ed-2018/Light_Transport_II_Volume_Rendering/Further_Reading), **DOM (Discrete Ordinates Method)** is used by \[Fattal 2009\] to calculate the diffusion profile.  

By ["15.5.2 Diffusion Theory"](https://www.pbr-book.org/3ed-2018/Light_Transport_II_Volume_Rendering/Subsurface_Scattering_Using_the_Diffusion_Equation#DiffusionTheory) and ["11.1.3 Out-Scattering and Attenuation"](https://www.pbr-book.org/3ed-2018/Volume_Scattering/Volume_Scattering_Processes#Out-ScatteringandAttenuation) of [PBR Book V3](https://www.pbr-book.org/3ed-2018/contents), we have the **RTE (Radiative Transfer Equation)** $\displaystyle \frac{\partial \operatorname{L}(\overrightarrow{p} + \overrightarrow{\omega}t, \overrightarrow{\omega})}{\partial t} = \operatorname{L_e}(\overrightarrow{p}, \overrightarrow{\omega}) - \operatorname{\sigma_t}(\overrightarrow{p}, \overrightarrow{\omega}) \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) + \operatorname{\sigma_s}(\overrightarrow{p}, \overrightarrow{\omega}) \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{{\omega}'}) \operatorname{p}(\overrightarrow{p}, \overrightarrow{\omega}, \overrightarrow{{\omega}'}) \, d \overrightarrow{{\omega}'} = \operatorname{L_e}(\overrightarrow{p}, \overrightarrow{\omega}) - \left\lparen \operatorname{\sigma_a}(\overrightarrow{p}, \overrightarrow{\omega}) + \operatorname{\sigma_s}(\overrightarrow{p}, \overrightarrow{\omega}) \right\rparen \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) + \operatorname{\sigma_s}(\overrightarrow{p}, \overrightarrow{\omega}) \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{{\omega}'}) \operatorname{p}(\overrightarrow{p}, \overrightarrow{\omega}, \overrightarrow{{\omega}'}) \, d \overrightarrow{{\omega}'}$.  

### Dipole

By \[Jensen 2001\] and ["Equation \(15.15\)"](https://www.pbr-book.org/3ed-2018/Light_Transport_II_Volume_Rendering/Subsurface_Scattering_Using_the_Diffusion_Equation#DiffusionTheory) of [PBR Book V3](https://www.pbr-book.org/3ed-2018/contents), we have the **reduced scattering coefficient** $\displaystyle \operatorname{\sigma_s'}(\overrightarrow{p}, \overrightarrow{\omega}) = (1 - g) \operatorname{\sigma_s}(\overrightarrow{p}, \overrightarrow{\omega})$ and **isotropic phase function** $\displaystyle \operatorname{p}(\overrightarrow{p}, \overrightarrow{\omega}, \overrightarrow{{\omega}'}) = \frac{1}{4 \pi}$. This means that the RTE can be written as $\displaystyle \frac{\partial \operatorname{L}(\overrightarrow{p} + \overrightarrow{\omega}t, \overrightarrow{\omega})}{\partial t} = \operatorname{L_e}(\overrightarrow{p}, \overrightarrow{\omega}) - \left\lparen \operatorname{\sigma_a}(\overrightarrow{p}, \overrightarrow{\omega}) + \operatorname{\sigma_s'}(\overrightarrow{p}, \overrightarrow{\omega}) \right\rparen \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) + \frac{\operatorname{\sigma_s'}(\overrightarrow{p}, \overrightarrow{\omega})}{4 \pi} \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{{\omega}'}) \, d \overrightarrow{{\omega}'}$.  

By \[Jensen 2001\] and ["Equation \(15.16\)"](https://www.pbr-book.org/3ed-2018/Light_Transport_II_Volume_Rendering/Subsurface_Scattering_Using_the_Diffusion_Equation#DiffusionTheory) of [PBR Book V3](https://www.pbr-book.org/3ed-2018/contents), the unknown function $\displaystyle \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega})$ can be approximated by the expansion $\displaystyle \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \approx \frac{1}{4 \pi} \operatorname{\phi}(\overrightarrow{p}) + \frac{3}{4 \pi} \overrightarrow{\omega} \cdot \operatorname{\overrightarrow{E}}(\overrightarrow{p})$ where $\displaystyle \operatorname{\phi}(\overrightarrow{p}) = \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \, d \overrightarrow{\omega}$ and $\displaystyle \operatorname{\overrightarrow{E}}(\overrightarrow{p}) = \begin{bmatrix} \displaystyle \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \omega_x \, d \overrightarrow{\omega} & \displaystyle \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \omega_y \, d \overrightarrow{\omega} & \displaystyle \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \omega_z \, d \overrightarrow{\omega} \end{bmatrix}$.  

Proof  

> Since the **SH(Spherical Harmonics)** were NOT popular, this expansion was based on the spherical moments by \[Jensen 2001\].  
> 
> However, it is much more convenient to prove this expansion based on the SH.  
>  
> By "Projection and Reconstruction" of \[Sloan 2008\], we have the expansion based on the SH $\displaystyle \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \approx L_0^0 \operatorname{\Upsilon_0^0}(\overrightarrow{\omega}) + L_1^{-1} \operatorname{\Upsilon_1^{-1}}(\overrightarrow{\omega}) + L_1^0 \operatorname{\Upsilon_1^0}(\overrightarrow{\omega}) + L_1^{-1} \operatorname{\Upsilon_1^{-1}}(\overrightarrow{\omega})$ where $\displaystyle L_l^m = \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \operatorname{\Upsilon_l^m}(\overrightarrow{\omega}) \, d \overrightarrow{\omega}$.  
>  
> By "Appendix A2" of \[Sloan 2008\], we have the **polynomial forms** of basis function $\displaystyle \operatorname{\Upsilon_0^0}(\overrightarrow{\omega}) = \frac{1}{2 \sqrt{\pi}}$, $\displaystyle \operatorname{\Upsilon_1^{-1}}(\overrightarrow{\omega}) = - \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_y$, $\displaystyle \operatorname{\Upsilon_1^0}(\overrightarrow{\omega}) = \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_z$ and $\displaystyle \operatorname{\Upsilon_1^1}(\overrightarrow{\omega}) = - \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_x$.  
>  
> This means that we have $\displaystyle L_0^0 = \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \frac{1}{2 \sqrt{\pi}} \, d \overrightarrow{\omega} = \frac{1}{2 \sqrt{\pi}} \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \, d \overrightarrow{\omega} = \frac{1}{2 \sqrt{\pi}} \operatorname{\phi}(\overrightarrow{p})$, $\displaystyle L_1^{-1} = \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \left\lparen - \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_y \right\rparen \, d \overrightarrow{\omega} = - \frac{\sqrt{3}}{2 \sqrt{\pi}} \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \omega_y \, d \overrightarrow{\omega} = - \frac{\sqrt{3}}{2 \sqrt{\pi}} \operatorname{E_y}(\overrightarrow{p})$, $\displaystyle L_1^0 = \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_z \, d \overrightarrow{\omega} = \frac{\sqrt{3}}{2 \sqrt{\pi}} \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \omega_z \, d \overrightarrow{\omega} = \frac{\sqrt{3}}{2 \sqrt{\pi}} \operatorname{E_z}(\overrightarrow{p})$ and $\displaystyle L_1^1 = \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \left\lparen - \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_x \right\rparen \, d \overrightarrow{\omega} = - \frac{\sqrt{3}}{2 \sqrt{\pi}} \int_{\mathrm{S}^2} \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \omega_x \, d \overrightarrow{\omega} = - \frac{\sqrt{3}}{2 \sqrt{\pi}} \operatorname{E_x}(\overrightarrow{p})$.  
>  
> And the expansion based on the SH can be calculated as $\displaystyle \operatorname{L}(\overrightarrow{p}, \overrightarrow{\omega}) \approx L_0^0 \operatorname{\Upsilon_0^0}(\overrightarrow{\omega}) + L_1^{-1} \operatorname{\Upsilon_1^{-1}}(\overrightarrow{\omega}) + L_1^0 \operatorname{\Upsilon_1^0}(\overrightarrow{\omega}) + L_1^{-1} \operatorname{\Upsilon_1^{-1}}(\overrightarrow{\omega}) = \frac{1}{2 \sqrt{\pi}} \operatorname{\phi}(\overrightarrow{p}) \frac{1}{2 \sqrt{\pi}} + \left\lparen - \frac{\sqrt{3}}{2 \sqrt{\pi}} \operatorname{E_y}(\overrightarrow{p}) \right\rparen \left\lparen - \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_y \right\rparen + \frac{\sqrt{3}}{2 \sqrt{\pi}} \operatorname{E_z}(\overrightarrow{p}) \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_z + \left\lparen - \frac{\sqrt{3}}{2 \sqrt{\pi}} \operatorname{E_x}(\overrightarrow{p}) \right\rparen \left\lparen - \frac{\sqrt{3}}{2 \sqrt{\pi}} \omega_x \right\rparen = \frac{1}{2 \pi} \operatorname{\phi}(\overrightarrow{p}) + \frac{3}{4 \pi} \left\lparen \operatorname{E_y}(\overrightarrow{p}) \omega_y + \operatorname{E_z}(\overrightarrow{p}) \omega_z + \operatorname{E_x}(\overrightarrow{p}) \omega_x \right\rparen = \frac{1}{2 \pi} \operatorname{\phi}(\overrightarrow{p}) + \frac{3}{4 \pi} \begin{bmatrix} \displaystyle \omega_x & \displaystyle \omega_y & \displaystyle \omega_z \end{bmatrix} \begin{bmatrix} \displaystyle \operatorname{E_x}(\overrightarrow{p}) & \displaystyle \operatorname{E_y}(\overrightarrow{p}) & \displaystyle \operatorname{E_z}(\overrightarrow{p}) \end{bmatrix} = \frac{1}{4 \pi} \operatorname{\phi}(\overrightarrow{p}) + \frac{3}{4 \pi} \overrightarrow{\omega} \cdot \operatorname{\overrightarrow{E}}(\overrightarrow{p})$.  
>  

## References  
\[Jensen 2001\] [Henrik Jensen, Steve Marschner, Marc Levoy, Pat Hanrahan. "A Practical Model for Subsurface Light Transport." SIGGRAPH 2001.](http://www.graphics.stanford.edu/papers/bssrdf/)  
\[Donner 2005\] [Craig Donner, Henrik Wann Jensen. "Light Diffusion in Multi-Layered Translucent Materials." SIGGRAPH 2005.](http://graphics.ucsd.edu/~henrik/papers/layered/)  
\[Sloan 2008\] [Peter-Pike Sloan. "Stupid Spherical Harmonics (SH) Tricks." GDC 2008.](http://www.ppsloan.org/publications/StupidSH36.pdf)  
\[Fattal 2009\] [Raanan Fattal. "Participating Media Illumination using Light Propagation Maps." TOG 2009.](https://www.cs.huji.ac.il/w~raananf/projects/lpm/)  
\[Arbree 2010\] [Adam Arbree. "Heterogeneous Subsurface Scattering Using the Finite Element Method." TVCG 2010.](https://www.cs.cornell.edu/%7Earbree/)  
